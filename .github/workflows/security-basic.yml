name: Basic Security Scanning

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop
  schedule:
    # Run security scans weekly on Sundays at 3 AM UTC
    - cron: '0 3 * * 0'
  workflow_dispatch:

jobs:
  vulnerability-scan:
    name: Vulnerability Scanning
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install PHP dependencies
        run: composer install --no-dev --optimize-autoloader

      - name: Install Node.js dependencies
        run: npm ci --only=production

      - name: Run Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Generate vulnerability report
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'json'
          output: 'vulnerability-report.json'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Check for critical vulnerabilities
        id: vuln-check
        run: |
          # Count critical and high vulnerabilities
          CRITICAL=$(jq '.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL") | .VulnerabilityID' vulnerability-report.json 2>/dev/null | wc -l || echo "0")
          HIGH=$(jq '.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH") | .VulnerabilityID' vulnerability-report.json 2>/dev/null | wc -l || echo "0")

          echo "Critical vulnerabilities: $CRITICAL"
          echo "High vulnerabilities: $HIGH"
          echo "critical=$CRITICAL" >> $GITHUB_OUTPUT
          echo "high=$HIGH" >> $GITHUB_OUTPUT

          # Create summary
          echo "## ðŸ” Vulnerability Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Critical:** $CRITICAL" >> $GITHUB_STEP_SUMMARY
          echo "- **High:** $HIGH" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$CRITICAL" -gt "0" ] || [ "$HIGH" -gt "5" ]; then
            echo "âš ï¸ **Action Required:** Please review and address the vulnerabilities found." >> $GITHUB_STEP_SUMMARY
            echo "should_fail=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… **Status:** No critical issues found." >> $GITHUB_STEP_SUMMARY
            echo "should_fail=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload vulnerability report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: vulnerability-report-${{ github.run_number }}
          path: vulnerability-report.json
          retention-days: 30

      - name: Fail on critical vulnerabilities
        if: steps.vuln-check.outputs.should_fail == 'true'
        run: |
          echo "âŒ Critical vulnerabilities detected. Please review the vulnerability report."
          echo "Critical: ${{ steps.vuln-check.outputs.critical }}"
          echo "High: ${{ steps.vuln-check.outputs.high }}"
          exit 1

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: 8.4
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Install dependencies
        run: |
          composer install --no-interaction
          npm ci

      - name: Run Composer audit
        id: composer-audit
        run: |
          echo "## ðŸ” PHP Dependencies Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if composer audit --format=json > composer-audit.json 2>/dev/null; then
            echo "âœ… **Composer Audit:** No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Composer Audit:** Issues found - see report" >> $GITHUB_STEP_SUMMARY
            cat composer-audit.json || echo "No detailed report available"
          fi
        continue-on-error: true

      - name: Run npm audit
        id: npm-audit
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸ“¦ Node.js Dependencies Audit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Run npm audit and capture results
          if npm audit --audit-level=moderate --json > npm-audit.json 2>/dev/null; then
            echo "âœ… **npm Audit:** No moderate+ vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            VULNERABILITIES=$(jq -r '.metadata.vulnerabilities | to_entries[] | "\(.key): \(.value)"' npm-audit.json 2>/dev/null || echo "Unable to parse")
            echo "âš ï¸ **npm Audit:** Issues found" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY
            echo "$VULNERABILITIES" >> $GITHUB_STEP_SUMMARY
            echo "```" >> $GITHUB_STEP_SUMMARY

            # Show summary in console
            npm audit --audit-level=moderate || true
          fi
        continue-on-error: true

      - name: Upload audit reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-audit-${{ github.run_number }}
          path: |
            composer-audit.json
            npm-audit.json
          retention-days: 30

  docker-scan:
    name: Docker Image Security
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.actor != 'dependabot[bot]'
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          tags: security-scan:latest
          outputs: type=docker,dest=/tmp/image.tar
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Scan Docker image
        uses: aquasecurity/trivy-action@master
        with:
          input: /tmp/image.tar
          format: 'table'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'

      - name: Generate Docker security report
        uses: aquasecurity/trivy-action@master
        with:
          input: /tmp/image.tar
          format: 'json'
          output: 'docker-security.json'
          severity: 'CRITICAL,HIGH,MEDIUM'

      - name: Docker security summary
        run: |
          echo "## ðŸ³ Docker Image Security Scan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "docker-security.json" ]; then
            CRITICAL=$(jq '.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL") | .VulnerabilityID' docker-security.json 2>/dev/null | wc -l || echo "0")
            HIGH=$(jq '.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH") | .VulnerabilityID' docker-security.json 2>/dev/null | wc -l || echo "0")

            echo "- **Critical:** $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- **High:** $HIGH" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$CRITICAL" -gt "0" ]; then
              echo "âŒ **Critical vulnerabilities found in Docker image**" >> $GITHUB_STEP_SUMMARY
            elif [ "$HIGH" -gt "10" ]; then
              echo "âš ï¸ **High number of high-severity vulnerabilities**" >> $GITHUB_STEP_SUMMARY
            else
              echo "âœ… **Docker image security looks good**" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ **Unable to generate security report**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Upload Docker security report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: docker-security-${{ github.run_number }}
          path: docker-security.json
          retention-days: 30

  security-summary:
    name: Security Summary
    runs-on: ubuntu-latest
    needs: [vulnerability-scan, dependency-audit, docker-scan]
    if: always()
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Generate overall summary
        run: |
          echo "# ðŸ”’ Security Scan Summary" > security-summary.md
          echo "" >> security-summary.md
          echo "**Scan Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> security-summary.md
          echo "**Commit:** ${{ github.sha }}" >> security-summary.md
          echo "**Branch:** ${{ github.ref_name }}" >> security-summary.md
          echo "" >> security-summary.md

          echo "## ðŸ“Š Scan Results" >> security-summary.md
          echo "" >> security-summary.md

          # Check results
          if [ "${{ needs.vulnerability-scan.result }}" = "success" ]; then
            echo "âœ… **Vulnerability Scan:** Passed" >> security-summary.md
          else
            echo "âŒ **Vulnerability Scan:** Failed" >> security-summary.md
          fi

          if [ "${{ needs.dependency-audit.result }}" = "success" ]; then
            echo "âœ… **Dependency Audit:** Passed" >> security-summary.md
          else
            echo "âš ï¸ **Dependency Audit:** Issues found" >> security-summary.md
          fi

          if [ "${{ needs.docker-scan.result }}" = "success" ] || [ "${{ needs.docker-scan.result }}" = "skipped" ]; then
            echo "âœ… **Docker Security:** Passed" >> security-summary.md
          else
            echo "âŒ **Docker Security:** Failed" >> security-summary.md
          fi

          echo "" >> security-summary.md
          echo "## ðŸ“ Reports Available" >> security-summary.md
          echo "" >> security-summary.md
          echo "Download the following artifacts from this workflow run:" >> security-summary.md
          echo "- \`vulnerability-report-${{ github.run_number }}\` - Detailed vulnerability scan" >> security-summary.md
          echo "- \`dependency-audit-${{ github.run_number }}\` - PHP and Node.js dependency audit" >> security-summary.md

          if [ "${{ needs.docker-scan.result }}" != "skipped" ]; then
            echo "- \`docker-security-${{ github.run_number }}\` - Docker image security scan" >> security-summary.md
          fi

          echo "" >> security-summary.md
          echo "---" >> security-summary.md
          echo "*Generated by GitHub Actions Security Workflow*" >> security-summary.md

          cat security-summary.md

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            try {
              const summary = fs.readFileSync('security-summary.md', 'utf8');

              // Check if there's already a comment from this workflow
              const comments = await github.rest.issues.listComments({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
              });

              const botComment = comments.data.find(comment =>
                comment.user.type === 'Bot' &&
                comment.body.includes('Security Scan Summary')
              );

              if (botComment) {
                // Update existing comment
                await github.rest.issues.updateComment({
                  comment_id: botComment.id,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: summary
                });
              } else {
                // Create new comment
                await github.rest.issues.createComment({
                  issue_number: context.issue.number,
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  body: summary
                });
              }
            } catch (error) {
              console.log('Error posting comment:', error);
            }

      - name: Upload security summary
        uses: actions/upload-artifact@v4
        with:
          name: security-summary-${{ github.run_number }}
          path: security-summary.md
          retention-days: 90
